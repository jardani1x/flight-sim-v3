<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Flight Simulator - M1 World + Aircraft</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; font-family: sans-serif; background: #000; }
    #cesium-container { width: 100%; height: 100%; }
    .loading {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: #000; display: flex; flex-direction: column;
      align-items: center; justify-content: center; z-index: 9999;
      color: #0f0; font-size: 24px;
    }
    .loading.hidden { display: none; }
    .controls-hint {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.7); color: #888; padding: 10px 20px;
      border-radius: 20px; font-size: 14px; z-index: 100;
    }
    .hud {
      position: fixed; top: 20px; left: 20px;
      background: rgba(0,0,0,0.7); color: #0f0; padding: 15px;
      border-radius: 8px; font-family: monospace; z-index: 100;
    }
    .hud div { margin-bottom: 5px; }
  </style>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
</head>
<body>
  <div class="loading" id="loading">Loading M1...</div>
  <div id="cesium-container"></div>
  
  <div class="hud" id="hud">
    <div>POS: <span id="pos">0, 0, 0</span></div>
    <div>HDG: <span id="hdg">0</span>Â°</div>
    <div>SPEED: <span id="speed">0</span> m/s</div>
    <div>FPS: <span id="fps">0</span></div>
  </div>
  
  <div class="controls-hint">
    WASD = Move | Arrow Keys = Turn | Q/E = Up/Down | Space = Boost
  </div>
  
  <script>
    const CESIUM_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJmZTVkZWJkZC1lMDdlLTQyYzMtYWIyNS01YmUzZTc4Y2JmMGIiLCJpZCI6MzkyOTEzLCJpYXQiOjE3NzE3MzAzNjh9.lNWe3qqelAGSjQAMwJv8jrHbdxKFmFYq7UB80y4O6CU';
    
    // Flight state
    const state = {
      lon: 103.9915,
      lat: 1.3644,
      alt: 500,
      heading: 90,
      speed: 0,
      maxSpeed: 200
    };
    
    // Controls
    const keys = {};
    document.addEventListener('keydown', e => keys[e.code] = true);
    document.addEventListener('keyup', e => keys[e.code] = false);
    
    function updateControls(dt) {
      const turnRate = 30 * dt;
      const moveSpeed = 100 * dt;
      
      // Turn
      if (keys['ArrowLeft']) state.heading -= turnRate;
      if (keys['ArrowRight']) state.heading += turnRate;
      
      // Move forward
      if (keys['KeyW']) {
        state.lon += Math.sin(state.heading * Math.PI / 180) * moveSpeed / 111320;
        state.lat += Math.cos(state.heading * Math.PI / 180) * moveSpeed / 111320;
      }
      if (keys['KeyS']) {
        state.lon -= Math.sin(state.heading * Math.PI / 180) * moveSpeed / 111320;
        state.lat -= Math.cos(state.heading * Math.PI / 180) * moveSpeed / 111320;
      }
      
      // Altitude
      if (keys['KeyQ']) state.alt += moveSpeed;
      if (keys['KeyE']) state.alt -= moveSpeed;
      state.alt = Math.max(50, state.alt);
      
      // Speed boost
      if (keys['Space']) state.speed = state.maxSpeed;
      else state.speed = keys['KeyW'] ? state.maxSpeed * 0.5 : 0;
      
      // Update HUD
      document.getElementById('pos').textContent = 
        `${state.lon.toFixed(4)}, ${state.lat.toFixed(4)}, ${state.alt.toFixed(0)}`;
      document.getElementById('hdg').textContent = ((state.heading % 360) + 360) % 360 | 0;
      document.getElementById('speed').textContent = state.speed | 0;
    }
    
    // FPS counter
    let frameCount = 0, lastFpsTime = performance.now();
    function updateFPS() {
      frameCount++;
      const now = performance.now();
      if (now - lastFpsTime >= 1000) {
        document.getElementById('fps').textContent = frameCount;
        frameCount = 0;
        lastFpsTime = now;
      }
    }
    
    async function init() {
      Cesium.Ion.defaultAccessToken = CESIUM_TOKEN;
      
      const viewer = new Cesium.Viewer('cesium-container', {
        terrainProvider: await Cesium.createWorldTerrainAsync(),
        baseLayerPicker: false, geocoder: false, homeButton: false,
        sceneModePicker: false, selectionIndicator: false, timeline: false,
        animation: false, navigationHelpButton: false, fullscreenButton: false,
        infoBox: false, shouldAnimate: false
      });
      
      // F-16 Aircraft
      const aircraft = viewer.entities.add({
        position: new Cesium.CallbackProperty(() => {
          return Cesium.Cartesian3.fromDegrees(state.lon, state.lat, state.alt);
        }, false),
        orientation: new Cesium.CallbackProperty(() => {
          return Cesium.Transforms.headingPitchRollQuaternion(
            Cesium.Cartesian3.fromDegrees(state.lon, state.lat, state.alt),
            new Cesium.HeadingPitchRoll(
              Cesium.Math.toRadians(state.heading),
              0, 0
            )
          );
        }, false),
        model: {
          uri: 'https://cesium.com/public/Sandcastle/SampleData/models/CesiumAir/Cesium_Air.glb',
          scale: 15
        },
        label: {
          text: 'F-16', font: '16px sans-serif', fillColor: Cesium.Color.YELLOW,
          pixelOffset: new Cesium.Cartesian2(0, -40)
        }
      });
      
      // Airport marker
      viewer.entities.add({
        position: Cesium.Cartesian3.fromDegrees(103.9915, 1.3644, 0),
        point: { pixelSize: 12, color: Cesium.Color.CYAN },
        label: { text: 'ðŸ›« Singapore', font: '14px sans-serif' }
      });
      
      document.getElementById('loading').classList.add('hidden');
      
      // Chase camera
      let lastTime = performance.now();
      function gameLoop() {
        const now = performance.now();
        const dt = (now - lastTime) / 1000;
        lastTime = now;
        
        updateControls(dt);
        updateFPS();
        
        // Chase camera - behind and above aircraft
        const h = state.heading * Math.PI / 180;
        const camLon = state.lon - Math.sin(h) * 0.02;
        const camLat = state.lat - Math.cos(h) * 0.02;
        
        viewer.camera.setView({
          destination: Cesium.Cartesian3.fromDegrees(camLon, camLat, state.alt + 200),
          orientation: {
            heading: Cesium.Math.toRadians(state.heading),
            pitch: Cesium.Math.toRadians(-15),
            roll: 0
          }
        });
        
        requestAnimationFrame(gameLoop);
      }
      
      gameLoop();
      console.log('M1: World + Aircraft ready');
    }
    
    init();
  </script>
</body>
</html>
